name: Java CI with Maven

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '*'

jobs:
  build-and-test:
    name: Build and test
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 2
      matrix:
        os: [ ubuntu-latest, windows-latest ]

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Setup Windows for Docker
        if: matrix.os == 'windows-latest'
        run: |
          Enable-WindowsOptionalFeature -Online -FeatureName Containers
          Invoke-WebRequest -UseBasicParsing "https://raw.githubusercontent.com/microsoft/Windows-Containers/Main/helpful_tools/Install-DockerCE/install-docker-ce.ps1" -o install-docker-ce.ps1
          .\install-docker-ce.ps1
          Start-Service Docker
          docker run -it --rm -p 8000:8080 --name aspnetcore_sample mcr.microsoft.com/dotnet/samples:aspnetapp
          docker pull mcr.microsoft.com/windows/nanoserver:ltsc2022
          Get-VM WinContainerHost | Set-VMProcessor -ExposeVirtualizationExtensions $true
          [Environment]::SetEnvironmentVariable("LCOW_SUPPORTED", "1", "Machine")
          Restart-Service docker
          
          $configfile = @”
          {
            “experimental”: true
          }“@
          $configfile|Out-File -FilePath C:\ProgramData\docker\config\daemon.json -Encoding ascii -Force
          Invoke-WebRequest -Uri "https://github.com/linuxkit/lcow/releases/download/v4.14.35-v0.3.9/release.zip" -UseBasicParsing -OutFile release.zip
          Expand-Archive release.zip -DestinationPath "$Env:ProgramFiles\Linux Containers\."
          
          Restart-Service docker
          docker version

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Deploy with Docker Compose
        run: |
          docker version
          docker-compose up -d
        continue-on-error: false

      - name: Build with Maven
        run: mvn clean install -DskipTests=true

      - name: Run Tests with Maven
        run: mvn test
